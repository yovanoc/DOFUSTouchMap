<!DOCTYPE html>
<html>
    <head>
        <meta charset='utf-8'>
        <title>DOFUS Touch Map</title>
        <link rel='stylesheet' href='https://unpkg.com/leaflet@1.3.1/dist/leaflet.css'/>
        <script src='https://unpkg.com/leaflet@1.3.1/dist/leaflet.js'></script>
        <link rel="stylesheet" type="text/css" href="style.css">
    </head>
    <script>
        function init() {
            const minZoom = 1;
            const maxZoom = 1; // maxZoom = minZoom, because it's kinda buggy somehow
            // create the map
            const map = L.map('map', {
                minZoom: minZoom,
                maxZoom: maxZoom,
                zoom: 1,
                crs: L.CRS.Simple,
            });

            const cellheight = 4096 / 161; // 4096 = 2x2048 (lat of the map's center). 161 = Number of map between left and right
            const cellwidth = 5120 / 144; // 5120 = 2x2560 (lng of the map's center). 144 = Number of map between the top and the bottom
            let dofus = [];
            dofus['lat'] = -cellheight * 100;
            dofus['lng'] = cellwidth * 94 - cellwidth / 4.5;

            const bounds = new L.LatLngBounds(map.unproject([0, 8192], maxZoom), map.unproject([10240, 0], maxZoom));

            map.fitBounds(bounds);

            L.tileLayer('./maps/1/{x}/{y}.jpg', {
                minZoom: minZoom,
                maxZoom: maxZoom,
                zoom: 1,
                noWrap: false,
                bounds: bounds,
            }).addTo(map);

            let xy = [];
            let storeXY = xy;
            let storeClick = xy;
            let mapXY = xy;
            let marker = {};
            let focused = false;
            //let mapArray = []; // Array<{latlng:['lat': number,'lng':number], actions:{fight:boolean, gather:boolean}}>
            let array;

            const rectangle = L.divIcon({
                iconSize: [2 * cellwidth, 2 * cellheight]
            });

            map.on('mousemove', (mouseEvent) => {
                xy = mapXYtoDofusXY(mouseEvent.latlng);
                if (((xy['lng'] !== storeXY['lng']) || (xy['lat'] !== storeXY['lat'])) && !focused) {
                    storeXY = xy;
                    storeClick = []; // reset storeClick
                    mapXY = DofusXYtomapXY(xy);
                    if (marker.isActive) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([mapXY['lat'], mapXY['lng']], { icon: rectangle }).addTo(map);  
                    marker.isActive = true;
                    document.getElementById('coords').innerText = `[${xy['lng'].toString()},${xy['lat'].toString()}]`;
                }
            });

            map.on('click', (mouseEvent) => {
                xy = mapXYtoDofusXY(mouseEvent.latlng);
                if ((xy['lng'] !== storeClick['lng']) || (xy['lat'] !== storeClick['lat'])) {
                    storeClick = xy;
                    focused = true;
                    mapXY = DofusXYtomapXY(xy);
                    if (marker.isActive) {
                        map.removeLayer(marker);
                    }
                    marker = L.marker([mapXY['lat'], mapXY['lng']], { icon: rectangle }).addTo(map);  
                    marker.isActive = true;
                    document.getElementById('coords').innerText = `[${xy['lng'].toString()},${xy['lat'].toString()}]`;
                } else {
                    focused = false; // disable focus on click on a focused map
                }
            });

            function mapXYtoDofusXY(latlng) {
                array = [];
                array['lng'] = Math.round((latlng.lng - dofus['lng']) / cellwidth);
                array['lat'] = Math.round((-latlng.lat + dofus['lat']) / cellheight);
                return array
            }

            function DofusXYtomapXY(xy) {
                array = [];
                array['lng'] = Math.round(xy['lng'] * cellwidth + dofus['lng']);
                array['lat'] = Math.round(-(xy['lat'] * cellheight - dofus['lat']));
                return array
            }

            function config() {
                function createInput(name, value, min, max) {
                    let element = document.getElementById('config');
                    element = element.appendChild(document.createElement('label'));
                    element.innerText = name;
                    element = element.appendChild(document.createElement('input'));
                    element.setAttribute('type', 'number');
                    element.setAttribute('value', value);
                    element.setAttribute('id', name);
                    if (min && max) {
                        element.setAttribute('min', min);
                        element.setAttribute('max', max);
                    }
                }

                function createCheckbox(name) {
                    let element = document.getElementById('config');
                    element = element.appendChild(document.createElement('div'));
                    element.setAttribute('class', 'checkbox checkbox-ripple');
                    let label = element.appendChild(document.createElement('label'));
                    label.setAttribute('for', name);
                    label.innerText = name;
                    label = element.appendChild(document.createElement('label'));
                    label.setAttribute('class', 'input-checkbox');
                    const input = label.appendChild(document.createElement('input'));
                    input.setAttribute('type', 'checkbox');
                    input.setAttribute('id', name);
                    const span = label.appendChild(document.createElement('span'));
                    span.setAttribute('class', 'checkbox-span');
                }

                function createDropdownList(name, type) {
                    function createList(id, type) {
                        let element = document.getElementById(id);
                        const button = element.appendChild(document.createElement('div'));
                        button.innerText = `Add ${type}`
                        button.setAttribute('class', 'button');
                        button.setAttribute('onclick', `openPopup('${type}')`);
                        element = element.appendChild(document.createElement('nav'));
                        element = element.appendChild(document.createElement('ul'));
                        element.setAttribute('id', `ul-${id}`);
                    }
                    function addLi(id, name) {
                        let element = document.getElementById(id);
                        element = element.appendChild(document.createElement('li'));
                        element.innerText = name;
                    }
                    let element = document.getElementById('config');
                    element = element.appendChild(document.createElement('div'));
                    element.setAttribute('class', 'item');
                    element.setAttribute('style', 'cursor:pointer;');
                    element.setAttribute('onclick', `showDropdown('${name}')`);
                    element.setAttribute('id', `item-${name}`);
                    let title = element.appendChild(document.createElement('div'));
                    title.setAttribute('id', `title-${name}`);
                    title.innerText = name;
                    element = element.appendChild(document.createElement('div'));
                    element.setAttribute('class', 'content');
                    element.setAttribute('style', 'display: none;');
                    element.setAttribute('id', `display-${name}`);
                    createList(`display-${name}`, type);
                    addLi(`ul-display-${name}`, 'test');
                }

                let form = document.createElement('form');
                //form.innerText = '';
                form.setAttribute('id', 'config');
                form = document.getElementById('scriptTools').appendChild(form);
                form.appendChild(document.createElement('br'));
                createInput('MAX_PODS', 90, 0, 100); // number
                createInput('MIN_MONSTERS', 1, 0, 8); // number
                createInput('MAX_MONSTERS', 8, 0, 8); // number
                createInput('MIN_MONSTERS_LEVEL', 1); // number
                createInput('MAX_MONSTERS_LEVEL', 1000); // number
                createInput('MAX_FIGHTS_PER_MAP'); // number
                createInput('BANK_PUT_KAMAS'); // number
                createInput('BANK_GET_KAMAS'); // number
                createCheckbox('OPEN_BAGS'); // boolean
                createCheckbox('DISPLAY_GATHER_COUNT'); // boolean
                createCheckbox('DISPLAY_FIGHT_COUNT'); // boolean
                createDropdownList('FORBIDDEN_MONSTERS', 'monster'); // Array<monstersIds>
                createDropdownList('MANDATORY_MONSTERS', 'monster'); // Array<monstersIds>
                createDropdownList('ELEMENTS_TO_GATHER', 'resource'); // Array<resourcesIds>
                createDropdownList('BANK_PUT_ITEMS', 'item'); // Array<itemsIds>
                createDropdownList('BANK_GET_ITEMS', 'item'); // Array<itemsIds>
                createDropdownList('AUTO_REGEN', 'item'); // Array<itemsIds>
                createDropdownList('AUTO_DELETE', 'item'); // Array<itemsIds>
            }
            config();

            function getValues() {
                
            }
        }
        function showDropdown(id) {
            const item = document.getElementById(`item-${id}`);
            item.removeAttribute('onclick');
            item.removeAttribute('style');
            document.getElementById(`display-${id}`).setAttribute('style', 'display:initial; cursor:initial;');
            const title = document.getElementById(`title-${id}`);
            title.setAttribute('onclick', `hideDropdown('${id}')`);
            title.setAttribute('style', 'cursor:pointer;');
        }
        function hideDropdown(id) {
            const title = document.getElementById(`title-${id}`);
            title.removeAttribute('onclick');
            title.removeAttribute('style');
            document.getElementById(`display-${id}`).setAttribute('style', 'display:none;');
            const item = document.getElementById(`item-${id}`);
            item.setAttribute('onclick', `fixBugHide('${id}')`);
            item.setAttribute('style', 'cursor:pointer;');
        }
        function fixBugHide(id) { // hideDropdown calls directly showDropdown, so the dropdown never hide.
            document.getElementById(`item-${id}`).setAttribute('onclick', `showDropdown('${id}')`);
        }
        function openPopup(type) {
            console.log(type);
            // TODO open popup
        }
    </script>
    <body onload='init()'>
        <div id='map'></div>
        <div class='menu'></div>
        <div class='menu-lateral'>
            <p align='center' id='coords'>[0,0]</p>
            <div id='scriptTools'></div>
        </div>
    </body>
</html>
